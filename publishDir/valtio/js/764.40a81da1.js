"use strict";(self.webpackChunkemp_valtio=self.webpackChunkemp_valtio||[]).push([["764"],{9863:function(e,t,i){function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}i.d(t,{i8:function(){return ey},xz:function(){return ep}});function r(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e,t,i,n,r,o,a){try{var s=e[o](a),c=s.value}catch(e){i(e);return}s.done?t(c):Promise.resolve(c).then(n,r)}function a(e){return function(){var t=this,i=arguments;return new Promise(function(n,r){var a=e.apply(t,i);function s(e){o(a,n,r,s,c,"next",e)}function c(e){o(a,n,r,s,c,"throw",e)}s(void 0)})}}function s(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,i){return t&&c(e.prototype,t),i&&c(e,i),e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},n=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),n.forEach(function(t){var n,r,o;n=e,r=t,o=i[t],r in n?Object.defineProperty(n,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[r]=o})}return e}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i,n,r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var o=[],a=!0,s=!1;try{for(r=r.call(e);!(a=(i=r.next()).done)&&(o.push(i.value),!t||o.length!==t);a=!0);}catch(e){s=!0,n=e}finally{try{!a&&null!=r.return&&r.return()}finally{if(s)throw n}}return o}}(e,t)||y(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||y(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function y(e,t){if(e){if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if("Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i)return Array.from(i);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return n(e,t)}}function g(e,t){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var b,x,w,C=Object.defineProperty,E=function(e,t,i){var n,r,o;return n=e,r=(void 0===t?"undefined":m(t))!="symbol"?t+"":t,o=i,r in n?C(n,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[r]=o,i},k="1.0.6",_="YYEVA",T=new(function(){function e(){s(this,e),E(this,"warn"),E(this,"error"),E(this,"debug"),E(this,"info"),E(this,"log"),E(this,"op",{level:"debug",channel:"",showtips:!0}),E(this,"colors",{debug:"#3498db",info:"#16a085",warn:"#e67e22",error:"#e74c3c"}),E(this,"levels",{debug:1,info:2,warn:3,error:4})}return u(e,[{key:"logType",value:function(e){var t=e.toLocaleUpperCase(),i=[];return this.op.showtips&&(i=["%c ".concat(this.op.channel||_," %c ").concat(t," "),"background:#2c3e50;color:#fff;padding: 1px;border-radius: 2px 0 0 2px;","background:".concat(this.colors[e],";color: #fff;padding: 1px; border-radius: 0 2px 2px 0;")]),i}},{key:"setup",value:function(e){var t,i,n,r,o,a=self.LoggerConfig||{},s=a.channel,c=a.level,u=a.showtips;this.op=l({},this.op,e),"boolean"==typeof u&&(this.op.showtips=u);var h=c?this.levels[c]:this.op.level?this.levels[this.op.level]:2,d=!s||s===this.op.channel,f=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i]};this.error=h<=4&&d?(t=console.error).bind.apply(t,[console].concat(p(this.logType("error")))):f,this.warn=h<=3&&d?(i=console.warn).bind.apply(i,[console].concat(p(this.logType("warn")))):f,this.info=h<=2&&d?(n=console.log).bind.apply(n,[console].concat(p(this.logType("info")))):f,this.log=h<=2&&d?(r=console.log).bind.apply(r,[console].concat(p(this.logType("info")))):f,this.debug=h<=1&&d?(o=console.log).bind.apply(o,[console].concat(p(this.logType("debug")))):f}}]),e}()),F=navigator.userAgent.toLowerCase(),I=F.indexOf("micromessenger")>-1,S=/baidu/.test(F),R=/iphone|ipad|ipod/i.test(F),A=/macintosh/i.test(F),P=/^((?!chrome|android).)*safari/i.test(F);F.indexOf("mqqbrowser");var D=/android|adr/i.test(F),L=F.indexOf("ucbrowser")>-1,B=F.indexOf("quark")>-1,U=function(){var e=F.match(/chrome\/([\d\.]+)/),t=e?e[1]:"0.0.0";return(t=t.split(".")[0])?Number(t):0},O={baidu:S,weixin:I,ios:R,android:D,uc:L,quark:B,mac:A,safari:P},M=window;M.yyeva_wx_is_ready=!!M.yyeva_wx_is_ready;var N=new(function(){function e(){s(this,e),E(this,"isReady",!1)}return u(e,[{key:"ready",get:function(){return M.yyeva_wx_is_ready||this.isReady},set:function(e){M.yyeva_wx_is_ready=e,this.isReady=e}},{key:"initVideoIDPosition",value:function(e){var t=this;O.weixin&&O.ios&&document.addEventListener("WeixinJSBridgeReady",function(){t.ready=!0,e.map(function(e){var t=document.createElement("video");t.setAttribute("id",e),document.body.appendChild(t),t.style.visibility="hidden"})})}},{key:"wxReady",value:function(){var e=this;return T.debug("[wxReady] resolve",this.ready),new Promise(function(t){if(!O.weixin||!O.ios)return void t(!0);if(e.ready)return t(!0),void T.debug("[wxReady] resolve",e.ready);var i=setInterval(function(){T.debug("[wxReady] setInterval",e.ready),!0===e.ready&&(clearInterval(i),t(!0))},300);document.addEventListener("WeixinJSBridgeReady",function(){T.debug("[wxReady] WeixinJSBridgeReady",e.ready),e.ready=!0,i&&clearInterval(i),t(!0)})})}}]),e}()),V=function(e){return!d(e,HTMLInputElement)&&/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i.test(e)};function H(){return!(D&&70>=U())&&("undefined"==typeof OffscreenCanvas?"undefined":m(OffscreenCanvas))<"u"&&self.OffscreenCanvas}var j=((b=j||{}).NotAllowedError="NotAllowedError",b),W=((x=W||{}).canplaythrough="canplaythrough",x.muted="muted",x),q=((w=q||{}).aspectFill="aspectFill",w.aspectFit="aspectFit",w.scaleFill="scaleFill",w),z=function(){function e(t){s(this,e),E(this,"op"),E(this,"fps",30),E(this,"videoFps",30),E(this,"config"),E(this,"isUseMeta",!1),E(this,"hasAudio",!1),E(this,"ofs"),E(this,"ctx"),E(this,"effectTypes",{txt:["txt","text"],img:["img","image"]}),E(this,"effectWidth","effectWidth"),E(this,"effectHeight","effectHeight"),E(this,"effectTag","effectTag"),E(this,"effectType","effectType"),E(this,"effectId","effectId"),E(this,"renderFrame","renderFrame"),E(this,"outputFrame","outputFrame"),E(this,"frameIndex","frameIndex"),E(this,"scaleMode","scaleMode"),E(this,"data","data"),this.op=t;var i=H()?new OffscreenCanvas(300,300):document.createElement("canvas"),n=i.getContext("2d",{willReadFrequently:!0});this.ctx=n,this.ofs=i,t.useMetaData&&(this.isUseMeta=!0),t.dataUrl&&(this.effectHeight="h",this.effectWidth="w",this.effectTag="srcTag",this.effectType="srcType",this.effectId="srcId",this.renderFrame="frame",this.outputFrame="mFrame",this.frameIndex="i",this.data="obj")}return u(e,[{key:"destroy",value:function(){this.ofs&&(this.ctx=null,d(this.ofs,HTMLCanvasElement)?this.ofs.remove():this.ofs=void 0),this.config=void 0}},{key:"setConfig",value:function(e){this.config=e,e.descript.fps&&(this.fps=e.descript.fps,this.videoFps=e.descript.fps),e.descript.hasAudio&&(this.hasAudio=!0)}},{key:"setup",value:function(){var e=this;return a(function(){var t,i,n,r;return g(this,function(o){switch(o.label){case 0:if(!e.op.dataUrl)return[3,2];return[4,e.getConfig(e.op.dataUrl)];case 1:i=(t=o.sent()).info,n=t.src,r=t.frame,e.fps=i.fps||e.fps,i.fps&&(e.videoFps=i.fps),e.config={descript:{width:i.videoW,height:i.videoH,isEffect:i.isVapx,rgbFrame:i.rgbFrame,alphaFrame:i.aFrame,fps:i.fps,version:0},effect:n,datas:r},o.label=2;case 2:return e.op.fps&&(e.fps=e.op.fps),[4,e.parseFromSrcAndOptions()];case 3:return o.sent(),[2]}})})()}},{key:"isUseBitmap",get:function(){return!!self.createImageBitmap&&this.op.useBitmap}},{key:"dataURItoBlob",value:function(e){for(var t=e.split(",")[0].split(":")[1].split(";")[0],i=self.atob(e.split(",")[1]),n=new Uint8Array(new ArrayBuffer(i.length)),r=0;r<i.length;r++)n[r]=i.charCodeAt(r);return new Blob([n],{type:t})}},{key:"createImageElement",value:function(e){return new Promise(function(t,i){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){t(n)},n.onerror=function(t){T.error("frame load fail:"+e),i(void 0)},n.src=e})}},{key:"loadImg",value:function(e){var t=this;return a(function(){var i,n,r,o;return g(this,function(a){switch(a.label){case 0:if(a.trys.push([0,5,,6]),i=V(e),!t.isUseBitmap)return[3,4];if(!i)return[3,1];return r=t.dataURItoBlob(e),[3,3];case 1:return[4,fetch(e).then(function(t){return t.ok?t.blob():void T.error("fetch request failed, url: "+e)}).catch(function(e){T.error("fetch, err=",e)})];case 2:r=a.sent(),a.label=3;case 3:return[2,(n=r)?"canvas2d"===t.op.renderType?self.createImageBitmap(n):self.createImageBitmap(n,{imageOrientation:"flipY"}):void 0];case 4:return[2,("string"!=typeof e||-1!==e.indexOf("http")||i||(e="".concat(location.protocol,"//").concat(location.host).concat(e)),t.createImageElement(e))];case 5:return o=a.sent(),[2,void T.warn("fetch, else err=",o)];case 6:return[2]}})})()}},{key:"parseFromSrcAndOptions",value:function(){if(null!=(t=this.config)&&t.effect){var e,t,i=this.op.effects||{},n=this;return Promise.all(this.config.effect.map((e=a(function(e){var t,r,o,a,s;return g(this,function(c){switch(c.label){case 0:if(t=e[n.effectType],r=e[n.effectTag],!(n.effectTypes.txt.indexOf(t)>-1))return[3,3];if(!i[r])return[3,2];return o={fontStyle:i.fontStyle,fontColor:i.fontColor,fontSize:i.fontSize},"string"==typeof i[r]?e.text=i[r]:(e.text=i[r].text,(a=i[r]).fontStyle&&(o.fontStyle=a.fontStyle),a.fontColor&&(o.fontColor=a.fontColor),a.fontSize&&(o.fontSize=a.fontSize)),[4,n.makeTextImg(e,o,e.effectHeight)];case 1:e.img=c.sent(),c.label=2;case 2:return[3,6];case 3:if(!(s=n.effectTypes.img.indexOf(t)>-1))return[3,5];return[4,n.makeImage(e,i[r])];case 4:s=e.img=c.sent(),c.label=5;case 5:c.label=6;case 6:return[2]}})}),function(t){return e.apply(this,arguments)})))}}},{key:"makeImage",value:function(e,t){var i=this;return a(function(){var n,r,o,a,s,c,u,h,d,l,f,v,p,m,y;return g(this,function(g){switch(g.label){case 0:if(!i.ctx)return[2];if(n=i.ctx,r=Math.ceil(e[i.effectWidth]),o=Math.ceil(e[i.effectHeight]),a=null,!(s=t))return[3,2];return[4,i.loadImg(t)];case 1:s=a=g.sent(),g.label=2;case 2:if(n.canvas.width=r,n.canvas.height=o,!e.scaleMode||!a)return[2,a||(n.clearRect(0,0,r,o),n.getImageData(0,0,r,o))];switch(e.scaleMode){case q.aspectFill:return c=1,c=r/o>a.width/a.height?r/a.width:o/a.height,u=Math.round(a.width*c),h=Math.round(a.height*c),d=Math.round((r-u)/2),l=Math.round((h-o)/2),[2,(n.save(),n.translate(0,h),n.scale(1,-1),n.drawImage(a,d,l,u,h),n.restore(),n.getImageData(0,0,r,o))];case q.aspectFit:return f=1,f=r/o<a.width/a.height?r/a.width:o/a.height,v=Math.round(a.width*f),p=Math.round(a.height*f),m=Math.round((r-v)/2),y=Math.round((p-o)/2),[2,(n.save(),n.translate(0,p),n.scale(1,-1),n.drawImage(a,m,y,v,p),n.restore(),n.getImageData(0,0,r,o))];case q.scaleFill:default:return[2,a]}return[2]}})})()}},{key:"_getText",value:function(e,t,i){var n,r;if(!(null!=(r=null==(n=this.op)?void 0:n.font)&&r.overflow)||"cut"===this.op.font.overflow){var o=e.measureText(t).width;if(null==i)i=o;else if(o>i){for(var a=t.length;e.measureText(t+"...").width>i&&a>0;)a-=1,t=t.substring(0,a);t+="..."}}return t}},{key:"defaultFontInfo",value:function(e,t){if(D){var i="sans-serif",n=t.font.split(" ");return n&&n.length&&(i=n[n.length-1]),["normal","".concat(Math.round(e),"px"),i]}return R?["normal","".concat(Math.round(e),"px"),"SFUI-Heavy"]:["600","".concat(Math.round(e),"px"),"Microsoft YaHei"]}},{key:"makeTextImg",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};arguments.length>2&&void 0!==arguments[2]&&arguments[2];var i=this;return a(function(){var n,r,o,a,s,c,u,h,l,f,v,p,m,y;return g(this,function(g){switch(g.label){case 0:if(!i.ctx)return[2];if(n=i.ctx,t.fontStyle&&(e.fontStyle=t.fontStyle),t.fontColor&&(e.fontColor=t.fontColor),t.fontSize&&(e.fontSize=t.fontSize),r=e.fontStyle,o=e.fontColor,a=e.fontSize,s=Math.ceil(e[i.effectWidth]),c=Math.ceil(e[i.effectHeight]),n.canvas.width=s,n.canvas.height=c,n.textBaseline="middle",n.textAlign="center",h=(u=e.text||"").length,l=c-2,f=function(e){e=e||l,null!=(o=null==(t=i.op)?void 0:t.font)&&o.overflow&&"cut"!==i.op.font.overflow&&e*h>s-1&&(e=Math.min(s/h*1,l));var t,o,a=i.defaultFontInfo(e,n);return"b"===r&&a.unshift("bold"),a.join(" ")},r?"string"==typeof r?(n.font=r,o&&(n.fillStyle=o)):"object"==typeof r?(n.font=r.font||f(a),n.fillStyle=r.color||o):"function"==typeof r&&(n.font=f(a),o&&(n.fillStyle=o),r(null,n,e)):(v=f(a),n.font=v,o&&(n.fillStyle=o)),T.info("getFontStyle, style: ",n.font,", text:",u),n.clearRect(0,0,n.canvas.width,n.canvas.height),p=Math.floor(s/2),m=Math.floor(c/2),n.fillText(function(e,t,i){var n=document.createElement("div");n.style.position="absolute",n.style.visibility="hidden",n.style.whiteSpace="nowrap",n.style.left="-9999px",n.style.font=t,n.innerText=e,document.body.appendChild(n);var r=e,o=window.getComputedStyle(n).width;if(T.info("getTextByMaxWidth width=",o),parseInt(o,10)>i){for(var a=e.length;r=e.substring(0,a-1)+"...",n.innerText=r,console.log("getTextByMaxWidth.. width=",o=window.getComputedStyle(n).width,r),!(parseInt(o,10)<=i);)a-=1}return document.body.removeChild(n),r}(u,n.font,s),p,m),!(H()&&d(i.ofs,OffscreenCanvas)))return[3,2];return[4,i.ofs.convertToBlob()];case 1:return y=g.sent(),[2,"canvas2d"===i.op.renderType?self.createImageBitmap(y):self.createImageBitmap(y,{imageOrientation:"flipY"})];case 2:return[2,n.getImageData(0,0,s,c)]}})})()}},{key:"getFrame",value:function(e){var t=this;return this.config.datas&&this.config.datas.find(function(i){return i[t.frameIndex]===e})}},{key:"getConfig",value:function(e){return new Promise(function(t,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="json",n.onload=function(){200===n.status||304===n.status&&n.response?t(n.response):i(Error("http response invalid"+n.status))},n.send()})}}]),e}(),X=function(){function e(t){s(this,e),E(this,"PER_SIZE",9),E(this,"canvas"),E(this,"ctx"),E(this,"ofs"),E(this,"version"),E(this,"gl"),E(this,"op"),t.useOfsRender?(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),t.container.appendChild(this.canvas),t.resizeCanvas&&this.setSizeCanvas(this.canvas,t.resizeCanvas),this.ofs=H()&&self.createImageBitmap&&t.useBitmap?new OffscreenCanvas(300,300):document.createElement("canvas")):(this.ofs=document.createElement("canvas"),t.resizeCanvas&&this.setSizeCanvas(this.ofs,t.resizeCanvas),t.container.appendChild(this.ofs)),this.initGlContext(),this.op=t}return u(e,[{key:"setSizeCanvas",value:function(e,t){switch(t){case"percent":e.style.width="100%",e.style.height="100%";break;case"percentH":e.style.height="100%";break;case"percentW":e.style.width="100%"}}},{key:"initGlContext",value:function(){var e=this.ofs,t={alpha:!0,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,premultipliedAlpha:!0,stencil:!1,preserveDrawingBuffer:!1};this.gl=e.getContext("webgl2",t),this.version=2,this.gl||(this.gl=e.getContext("webgl",t),this.version=1,this.gl||(this.version="canvas2d")),T.debug("[Webgl]initGlContext, version=",this.version)}},{key:"destroy",value:function(){if(this.gl){this.gl.clear(this.gl.COLOR_BUFFER_BIT);var e=this.gl.getExtension("WEBGL_lose_context");e&&(e.loseContext(),T.debug("lose_context")),this.gl=null}this.canvas&&this.canvas.remove(),d(this.ofs,HTMLCanvasElement)?(this.ofs.remove(),this.gl=null,T.debug("[destroy remove canvas]")):this.ofs=void 0}},{key:"getVsSource",value:function(){return 2===this.version?this.getVs2():this.getVs1()}},{key:"getFsSource",value:function(){return 2===this.version?this.getFs2():this.getFs1()}},{key:"getVs2",value:function(){return"#version 300 es\n    in vec2 a_position; // 接受顶点坐标\n    in vec2 a_texCoord; // 接受纹理坐标\n    in vec2 a_alpha_texCoord; // 接受纹理坐标\n    out vec2 v_alpha_texCoord; // 接受纹理坐标\n    out vec2 v_texcoord; // 传递纹理坐标给片元着色器\n    uniform vec2 u_scale;\n    void main(void) {\n      gl_Position = vec4(u_scale * a_position, 0.0, 1.0); // 设置坐标\n      v_texcoord = a_texCoord; // 设置纹理坐标\n      v_alpha_texCoord = a_alpha_texCoord; // 设置纹理坐标\n    }\n    "}},{key:"getVs1",value:function(){return"attribute vec2 a_position; // 接受顶点坐标\n    attribute vec2 a_texCoord; // 接受纹理坐标\n    attribute vec2 a_alpha_texCoord; // 接受纹理坐标\n    varying vec2 v_alpha_texCoord; // 接受纹理坐标\n    varying vec2 v_texcoord; // 传递纹理坐标给片元着色器\n    uniform vec2 u_scale;\n    void main(void){\n       gl_Position = vec4(u_scale * a_position, 0.0, 1.0); // 设置坐标\n       v_texcoord = a_texCoord; // 设置纹理坐标\n       v_alpha_texCoord = a_alpha_texCoord; // 设置纹理坐标\n    }"}},{key:"getFs2",value:function(){if(!this.gl)return"";var e=this.gl,t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)-1,i="",n="";if(t>0&&(this.op.dataUrl||this.op.useMetaData)){for(var r=[],o=[],a=0;a<t;a++)r.push("if(ndx == ".concat(a+1,"){\n                          color = texture(u_image").concat(a+1,",uv);\n                      }")),o.push("uniform sampler2D u_image".concat(a+1,";"));n="\n              ".concat(o.join("\n"),"\n              uniform float image_pos[").concat(t*this.PER_SIZE,"];\n              vec4 getSampleFromArray(int ndx, vec2 uv) {\n                  vec4 color;\n                  ").concat(r.join(" else "),"\n                  return color;\n              }\n              "),i="\n              vec4 srcColor,maskColor;\n              vec2 srcTexcoord,maskTexcoord;\n              int srcIndex;\n              float x1,x2,y1,y2,mx1,mx2,my1,my2; //显示的区域\n\n              for(int i=0;i<".concat(t*this.PER_SIZE,";i+= ").concat(this.PER_SIZE,"){\n                  if ((int(image_pos[i]) > 0)) {\n                    srcIndex = int(image_pos[i]);\n\n                      x1 = image_pos[i+1];\n                      x2 = image_pos[i+2];\n                      y1 = image_pos[i+3];\n                      y2 = image_pos[i+4];\n\n                      mx1 = image_pos[i+5];\n                      mx2 = image_pos[i+6];\n                      my1 = image_pos[i+7];\n                      my2 = image_pos[i+8];\n\n\n                      if (v_texcoord.s>x1 && v_texcoord.s<x2 && v_texcoord.t>y1 && v_texcoord.t<y2) {\n                          srcTexcoord = vec2((v_texcoord.s-x1)/(x2-x1),(v_texcoord.t-y1)/(y2-y1));\n                           maskTexcoord = vec2(mx1+srcTexcoord.s*(mx2-mx1),my1+srcTexcoord.t*(my2-my1));\n                           srcColor = getSampleFromArray(srcIndex,srcTexcoord);\n                           maskColor = texture(u_image_video, maskTexcoord);\n                           srcColor.a = srcColor.a*(maskColor.r);\n\n                           bgColor = vec4(srcColor.rgb*srcColor.a,srcColor.a) + (1.0-srcColor.a)*bgColor;\n\n                      }\n                  }\n              }\n              ")}return"#version 300 es\n      precision lowp float;\n      in vec2 v_texcoord;\n      in vec2 v_alpha_texCoord;\n      out vec4 fragColor;\n      uniform sampler2D u_image_video;\n      ".concat(n,"\n\n      void main(void) {\n          vec4 bgColor = vec4(texture(u_image_video, v_texcoord).rgb, texture(u_image_video,v_alpha_texCoord).r);\n          ").concat(i,"\n          fragColor = bgColor;\n      }\n      ")}},{key:"getFs1",value:function(){if(!this.gl)return"";var e=this.gl,t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)-1,i="",n="";if(t>0){for(var r=[],o=[],a=0;a<t;a++)r.push("if(ndx == ".concat(a+1,"){\n                          color = texture2D(u_image").concat(a+1,",uv);\n                      }")),o.push("uniform sampler2D u_image".concat(a+1,";"));n="\n              ".concat(o.join("\n"),"\n              uniform float image_pos[").concat(t*this.PER_SIZE,"];\n              vec4 getSampleFromArray(int ndx, vec2 uv) {\n                  vec4 color;\n                  ").concat(r.join(" else "),"\n                  return color;\n              }\n              "),i="\n              vec4 srcColor,maskColor;\n              vec2 srcTexcoord,maskTexcoord;\n              int srcIndex;\n              float x1,x2,y1,y2,mx1,mx2,my1,my2; //显示的区域\n\n              for(int i=0;i<".concat(t*this.PER_SIZE,";i+= ").concat(this.PER_SIZE,"){\n                  if ((int(image_pos[i]) > 0)) {\n                    srcIndex = int(image_pos[i]);\n\n                      x1 = image_pos[i+1];\n                      x2 = image_pos[i+2];\n                      y1 = image_pos[i+3];\n                      y2 = image_pos[i+4];\n\n                      mx1 = image_pos[i+5];\n                      mx2 = image_pos[i+6];\n                      my1 = image_pos[i+7];\n                      my2 = image_pos[i+8];\n\n\n                      if (v_texcoord.s>x1 && v_texcoord.s<x2 && v_texcoord.t>y1 && v_texcoord.t<y2) {\n                          srcTexcoord = vec2((v_texcoord.s-x1)/(x2-x1),(v_texcoord.t-y1)/(y2-y1));\n                           maskTexcoord = vec2(mx1+srcTexcoord.s*(mx2-mx1),my1+srcTexcoord.t*(my2-my1));\n                           srcColor = getSampleFromArray(srcIndex,srcTexcoord);\n                           maskColor = texture2D(u_image_video, maskTexcoord);\n                           srcColor.a = srcColor.a*(maskColor.r);\n\n                           bgColor = vec4(srcColor.rgb*srcColor.a,srcColor.a) + (1.0-srcColor.a)*bgColor;\n\n                      }\n                  }\n              }\n              ")}return"\n      precision lowp float;\n      varying vec2 v_texcoord;\n      varying vec2 v_alpha_texCoord;\n      uniform sampler2D u_image_video;\n      ".concat(n,"\n\n      void main(void) {\n          vec4 bgColor = vec4(texture2D(u_image_video, v_texcoord).rgb, texture2D(u_image_video,v_alpha_texCoord).r);\n          ").concat(i,"\n          // bgColor = texture2D(u_image[0], v_texcoord);\n          gl_FragColor = bgColor;\n      }\n      ")}}]),e}(),G=function(){function e(t){s(this,e),E(this,"storeName"),E(this,"op"),E(this,"frameCacheCount",5),E(this,"requestAnimationFramePercent",.95),E(this,"hasRequestAnimationFrame",!1),E(this,"animationType"),E(this,"fps",0),E(this,"videoDurationTime",0),t.videoSource&&t.useFrameCache&&(this.op=t,this.storeName=function(e){var t=e.effects,i=e.mode,n=e.container,r=V(e.videoSource)?e.videoSource.substring(22,88):e.videoSource;if(t){var o=Object.keys(t).map(function(e){return e+"="+t[e]}).join("&");r+=(o.indexOf("?")>-1?"&":"?")+o}return n&&n.clientHeight&&(r+="".concat(r.indexOf("?")>-1?"&":"?","mode=").concat(i,"&height=").concat(n.clientHeight,"&width=").concat(n.clientWidth)),r=r.replace(/\s+/g,"")}(t),e.caches[this.storeName]||(T.debug("[mCache]","[实例化]"),e.caches[this.storeName]={},e.cacheKeys.push(this.storeName)),"number"==typeof t.useFrameCache&&t.useFrameCache>0&&(this.frameCacheCount=t.useFrameCache),T.debug("[mcache]","[constructor]","设置缓存数",this.frameCacheCount,"缓存视频",e.cacheKeys),T.debug("[mcache]",this.storeName,"当前缓存帧数 ".concat(Object.keys(e.caches[this.storeName]||{}).length)))}return u(e,[{key:"setOptions",value:function(e){var t=e.fps,i=e.animationType,n=e.videoDurationTime;this.fps=t,this.animationType=i,this.videoDurationTime=n,T.debug("[mcache]",{fps:t,animationType:i,videoDurationTime:n})}},{key:"setup",value:function(){var e=this;return a(function(){return g(this,function(t){return e.setAnimationStatus(),[2]})})()}},{key:"setAnimationStatus",value:function(){"requestVideoFrameCallback"!==this.animationType&&Object.keys(e.caches[this.storeName]||{}).length>0&&(this.hasRequestAnimationFrame=!0),T.debug("[mCache]","[setAnimationStatus]","hasRequestAnimationFrame",this.hasRequestAnimationFrame)}},{key:"isCache",value:function(){return Object.keys(e.caches[this.storeName]).length>0}},{key:"get",value:function(){return e.caches[this.storeName]}},{key:"set",value:function(t){e.caches[this.storeName]=t}},{key:"getFrame",value:function(t){return this.hasRequestAnimationFrame?e.caches[this.storeName]&&e.caches[this.storeName][t]?e.caches[this.storeName][t]:"skip":e.caches[this.storeName]?e.caches[this.storeName][t]:void 0}},{key:"setFrame",value:function(t,i){!i||e.caches[this.storeName][t]||this.hasRequestAnimationFrame||(e.caches[this.storeName][t]=i)}},{key:"checkCache",value:function(){if("requestVideoFrameCallback"!==this.animationType){var t=this.videoDurationTime*this.fps,i=t*this.requestAnimationFramePercent;i=Math.round(i);var n=e.caches[this.storeName]||{};T.debug("[mCache]","[checkCache] 当前缓存帧数",Object.keys(n).length,"需要缓存帧数",i,"缓存总数",t),n&&Object.keys(n).length<i&&(this.removeCacheItem(this.storeName),T.debug("[mCache]","[checkCache] removeCacheItem",this.storeName))}}},{key:"removeCache",value:function(){if(e.cacheKeys.length>this.frameCacheCount){for(var t=e.cacheKeys.length-this.frameCacheCount,i=1;i<t;i++){var n=e.cacheKeys.shift();this.removeCacheItem(n),T.debug("[mCache]","[removeCache]","达到视频缓存总数删除",n)}}}},{key:"removeCacheItem",value:function(t){e.caches[t]&&(delete e.caches[t],e.caches[t]={});var i=e.cacheKeys.indexOf(t);i>-1&&e.cacheKeys.splice(i,1)}},{key:"videoSeekedEvent",value:function(){this.checkCache(),this.setAnimationStatus()}},{key:"destroy",value:function(){T.debug("[mCache]","[destroy]"),this.removeCache(),this.checkCache()}}]),e}();E(G,"caches",{}),E(G,"cacheKeys",[]),E(G,"cachesOfs",{});var K=function(){function e(t,i){s(this,e),E(this,"canvas"),E(this,"op"),E(this,"mCache"),this.canvas=t,this.op=i,this.mCache=new G(this.op)}return u(e,[{key:"isCache",value:function(){return this.mCache.isCache()}},{key:"setCache",value:function(e){this.op.useFrameCache&&this.createFramesCache(e)}},{key:"getCache",value:function(e){if(this.op.useFrameCache)return this.mCache.getFrame(e)}},{key:"destroy",value:function(){this.mCache.destroy()}},{key:"setup",value:function(){var e=this;return a(function(){var t;return g(this,function(i){switch(i.label){case 0:if(!(t=e.op.useFrameCache))return[3,2];return[4,e.mCache.setup()];case 1:t=i.sent(),i.label=2;case 2:return[2]}})})()}},{key:"createFramesCache",value:function(e){var t=this;return a(function(){var i,n;return g(this,function(r){return t.canvas&&(t.op.useBitmap&&self.createImageBitmap?self.createImageBitmap(t.canvas).then(function(i){t.mCache.setFrame(e,i)}):"toDataURL"in t.canvas&&(i=t.canvas.toDataURL(),(n=new Image).src=i,t.mCache.setFrame(e,n))),[2]})})()}}]),e}(),Y=function(){function e(t){var i=this;s(this,e),E(this,"video"),E(this,"program"),E(this,"isPlay",!1),E(this,"op"),E(this,"videoEntity"),E(this,"webgl"),E(this,"renderCache"),E(this,"textureMap",{}),E(this,"imagePos"),E(this,"currentFrame",-1),T.debug("[Render In Webgl]"),this.op=t,this.webgl=new X(t),this.webgl.ofs.addEventListener("webglcontextlost",function(e){T.debug("[webglcontextlost]",e),e.preventDefault(),i.program=void 0}),this.webgl.ofs.addEventListener("webglcontextrestored",function(){T.debug("[webglcontextrestored]"),i.webgl.initGlContext(),i.initWebgl()}),this.renderCache=new K(this.webgl.ofs,this.op),this.videoEntity=new z(t)}return u(e,[{key:"videoSeekedEvent",value:function(){return this.renderCache.mCache.videoSeekedEvent()}},{key:"setup",value:function(e){var t=this;return a(function(){return g(this,function(i){switch(i.label){case 0:if(!e)throw Error("video must support!");return[4,t.renderCache.setup()];case 1:return i.sent(),[4,t.videoEntity.setup()];case 2:return i.sent(),t.video=e,t.resizeCanvasToDisplaySize(),t.initWebgl(),[2]}})})()}},{key:"resizeCanvasToDisplaySize",value:function(){var e,t=null==(e=this.videoEntity.config)?void 0:e.descript,i=this.webgl.ofs;if(t){var n=v(t.rgbFrame,4),r=(n[0],n[1],n[2]),o=n[3];i.width=r,i.height=o}else{if(!this.video)return;var a=this.video.videoWidth?this.video.videoWidth/2:900,s=this.video.videoHeight?this.video.videoHeight:1e3;T.debug("[resizeCanvasToDisplaySize]",a,s),i.width=a,i.height=s}this.op.useOfsRender&&(this.webgl.canvas.width=i.width,this.webgl.canvas.height=i.height)}},{key:"destroy",value:function(){this.webgl.destroy(),this.videoEntity.destroy(),this.renderCache.destroy()}},{key:"render",value:function(){var e,t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(this.isPlay&&this.webgl.gl&&this.video&&this.program&&this.currentFrame!==i){this.currentFrame=i;var n=this.webgl.gl;if(this.op.useFrameCache){var r=this.webgl.canvas,o=r.width,a=r.height,s=this.renderCache.getCache(i);if("skip"===s)return;if(s)return this.webgl.ctx.clearRect(0,0,o,a),void this.webgl.ctx.drawImage(s,0,0,o,a,0,0,o,a)}var c=null==(e=this.videoEntity.config)?void 0:e.descript;if(c){var u=this.videoEntity.getFrame(i),h=u?u[this.videoEntity.data]:void 0,d=[],l=c.width,f=c.height;h&&h.forEach(function(e){d[d.length]=+t.textureMap[e[t.videoEntity.effectId]];var i=v(c.rgbFrame,2),n=i[0],r=i[1],o=v(e[t.videoEntity.renderFrame],4),a=o[0],s=o[1],u=o[2],h=o[3],p=v(e[t.videoEntity.outputFrame],4),m=p[0],y=p[1],g=p[2],b=p[3],x=t.computeCoord(a+n,s+r,u,h,l,f),w=t.computeCoord(m,y,g,b,l,f);d=d.concat(x).concat(w)});var p=(n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS)-1)*this.webgl.PER_SIZE;d=d.concat(Array(p-d.length).fill(0)),this.imagePos=this.imagePos||n.getUniformLocation(this.program,"image_pos"),n.uniform1fv(this.imagePos,new Float32Array(d))}if(n.texImage2D(n.TEXTURE_2D,0,n.RGB,n.RGB,n.UNSIGNED_BYTE,this.video),n.drawArrays(n.TRIANGLE_STRIP,0,4),this.op.useOfsRender){var m=this.webgl.canvas,y=m.width,g=m.height;this.webgl.ctx.clearRect(0,0,y,g),this.webgl.ctx.drawImage(n.canvas,0,0,y,g,0,0,y,g)}this.op.useFrameCache&&this.renderCache.setCache(i)}}},{key:"getScale",value:function(){var e=1,t=1;if(this.video&&this.op.mode){var i=this.webgl.canvas?this.webgl.canvas:this.webgl.ofs,n=i.clientWidth/i.clientHeight,r=i.width/i.height;switch(i.setAttribute("class","e-video-".concat(this.op.mode.toLocaleLowerCase())),this.op.mode){case"AspectFill":case"vertical":t=1,e=r/n;break;case"AspectFit":case"horizontal":e=1,t=n/r;break;case"contain":t=1,(e=r/n)>1&&(t=1/e,e=1);break;case"Fill":case"cover":t=1,(e=r/n)<1&&(t=1/e,e=1)}}return[e,t]}},{key:"initWebgl",value:function(){if(!!this.webgl.gl){var e=this.webgl.gl;e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.disable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);var t=this.createProgram(e);if(t){this.program=t,this.initTexture(e,t),this.initVideoTexture(e,t);var i=e.getUniformLocation(t,"u_scale"),n=this.getScale();e.uniform2fv(i,new Float32Array(n))}}}},{key:"initTexture",value:function(e,t){var i,n=1,r=null==(i=this.videoEntity.config)?void 0:i.effect;if(r){for(var o in r){var a=r[o];a.img&&this.createTexture(e,n,a.img);var s=e.getUniformLocation(t,"u_image".concat(n));e.uniform1i(s,n),this.textureMap[a[this.videoEntity.effectId]]=n++}var c=e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,c),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,null)}this.createTexture(e,n);var u=e.getUniformLocation(t,"u_image_video");e.uniform1i(u,n)}},{key:"getRgbaPos",value:function(){var e,t=null==(e=this.videoEntity.config)?void 0:e.descript;if(t){var i=t.width,n=t.height,r=v(t.rgbFrame,4),o=r[0],a=r[1],s=r[2],c=r[3],u=v(t.alphaFrame,4);return{rgbX:o,rgbY:a,rgbW:s,rgbH:c,vW:i,vH:n,aX:u[0],aY:u[1],aW:u[2],aH:u[3]}}if(this.video){var h=this.video.videoWidth?this.video.videoWidth:1800,d=this.video.videoHeight?this.video.videoHeight:1e3,l=h/2,f=v("right"===this.op.alphaDirection?[0,0,l,d]:[l,0,l,d],4),p=f[0],m=f[1],y=f[2],g=f[3],b=v("right"===this.op.alphaDirection?[l,0,l,d]:[0,0,l,d],4);return{rgbX:p,rgbY:m,rgbW:y,rgbH:g,vW:h,vH:d,aX:b[0],aY:b[1],aW:b[2],aH:b[3]}}}},{key:"initVideoTexture",value:function(e,t){var i=[],n=this.getRgbaPos();if(n){var r=n.rgbX,o=n.rgbY,a=n.rgbW,s=n.rgbH,c=n.vW,u=n.vH,h=n.aX,d=n.aY,l=n.aW,f=n.aH,v=this.computeCoord(r,o,a,s,c,u),p=this.computeCoord(h,d,l,f,c,u);i.push(-1,1,v[0],v[3],p[0],p[3]),i.push(1,1,v[1],v[3],p[1],p[3]),i.push(-1,-1,v[0],v[2],p[0],p[2]),i.push(1,-1,v[1],v[2],p[1],p[2]);var m=new Float32Array(i);e.bindBuffer(e.ARRAY_BUFFER,e.createBuffer()),e.bufferData(e.ARRAY_BUFFER,m,e.STATIC_DRAW);var y=e.getAttribLocation(t,"a_position");e.enableVertexAttribArray(y);var g=e.getAttribLocation(t,"a_texCoord");e.enableVertexAttribArray(g);var b=e.getAttribLocation(t,"a_alpha_texCoord");e.enableVertexAttribArray(b);var x=m.BYTES_PER_ELEMENT;e.vertexAttribPointer(y,2,e.FLOAT,!1,6*x,0),e.vertexAttribPointer(g,2,e.FLOAT,!1,6*x,2*x),e.vertexAttribPointer(b,2,e.FLOAT,!1,6*x,4*x)}}},{key:"createProgram",value:function(e){var t=this.webgl.getVsSource(),i=this.webgl.getFsSource(),n=this.createShader(e,e.VERTEX_SHADER,t),r=this.createShader(e,e.FRAGMENT_SHADER,i),o=e.createProgram();if(o&&n&&r){if(e.attachShader(o,n),e.attachShader(o,r),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS)){var a=e.getProgramInfoLog(o);T.error(a)}return e.useProgram(o),o}}},{key:"createShader",value:function(e,t,i){var n=e.createShader(t);if(n)return e.shaderSource(n,i),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)||T.error(e.getShaderInfoLog(n)),n}},{key:"computeCoord",value:function(e,t,i,n,r,o){return[e/r,(e+i)/r,(o-t-n)/o,(o-t)/o]}},{key:"createTexture",value:function(e,t,i){var n=e.createTexture(),r=e.TEXTURE0+t;return T.debug("[createTexture]",r,t,"[ImageBitmap]Object"),e.activeTexture(r),e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),i&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),n}}]),e}(),Z=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(o,e);var t,i,n=(t=o,i=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,o,a=h(t);return o=i?Reflect.construct(a,arguments,h(this).constructor):a.apply(this,arguments),e=this,(n=o)&&("object"===m(n)||"function"==typeof n)?n:r(e)});function o(e){var t;return s(this,o),E(r(t=n.call(this)),"isPlay",!1),E(r(t),"webgl",{version:"canvas2d"}),E(r(t),"videoEntity"),E(r(t),"renderCache"),E(r(t),"video"),E(r(t),"ofs"),E(r(t),"ctx"),E(r(t),"canvas"),E(r(t),"context"),E(r(t),"op"),E(r(t),"alphaCanvas"),E(r(t),"alphaCtx"),E(r(t),"canvasKey"),E(r(t),"ctxKey"),E(r(t),"drawEffect"),T.debug("[Render In Canvas]"),t.op=e,t.ofs=t.createCanvas(),t.ctx=t.get2dContext(t.ofs),t.renderCache=new K(t.ofs,t.op),t.videoEntity=new z(e),t.alphaCanvas=t.createCanvas(),t.alphaCtx=t.get2dContext(t.alphaCanvas),t.drawEffect={},t.canvasKey=t.createCanvas(),t.ctxKey=t.get2dContext(t.canvasKey),t}return u(o,[{key:"setSizeCanvas",value:function(e,t){switch(t){case"percent":e.style.width="100%",e.style.height="100%";break;case"percentH":e.style.height="100%";break;case"percentW":e.style.width="100%"}}},{key:"getScale",value:function(){var e=[],t=[][0],i=[][1],n=[][2],r=[][3],o=[][4],a=[][5],s=[][6],c=[][7],u=this.canvas,h=u.width,d=u.height;u.clientWidth,u.clientHeight;var l=u.clientWidth/u.clientHeight;return u.width,u.height,o=0,a=0,s=h,c=d,t=0,i=0,n=h,r=d,this.op.mode&&(n=d*l,r=d,t=(h-n)/2,i=0),[t,i,n,r,o,a,s,c]}},{key:"videoSeekedEvent",value:function(){return T.debug("[canvas2d][videoSeekedEvent]"),this.renderCache.mCache.videoSeekedEvent()}},{key:"setup",value:function(e){var t=this;return a(function(){var i,n,r,o,a,s,c,u,h,d,l,f,p;return g(this,function(h){switch(h.label){case 0:if(!e)throw Error("video must support!");return[4,t.renderCache.setup()];case 1:return h.sent(),t.video=e,t.op.fps||(t.op.fps=10),[4,t.videoEntity.setup()];case 2:if(h.sent(),a=document.createElement("canvas"),t.op.container.appendChild(a),a.width=e.videoWidth/2,a.height=e.videoHeight,t.context=a.getContext("2d"),t.canvas=a,t.ofs.width=e.videoWidth,t.ofs.height=e.videoHeight,t.canvasKey.width=a.width,t.canvasKey.height=a.height,s=null==(n=null==(i=t.videoEntity)?void 0:i.config)?void 0:n.descript,c=null==(o=null==(r=t.videoEntity)?void 0:r.config)?void 0:o.effect,s&&((u=v(s.rgbFrame,4))[0],u[1],l=u[2],f=u[3],a.width=l,a.height=f,t.ofs.width=s.width,t.ofs.height=s.height),c)for(var d in c)(p=c[d]).img&&(t.drawEffect[p.effectId]=p);return t.setSizeCanvas(a,t.op.resizeCanvas),[2]}})})()}},{key:"destroy",value:function(){this.clear(),this.videoEntity.destroy(),this.canvas&&(this.canvas.remove(),delete this.canvas,this.canvas=null),this.removeCanvas(this.ofs),this.removeCanvas(this.alphaCanvas),this.removeCanvas(this.canvasKey),this.drawEffect=void 0}},{key:"clear",value:function(){var e,t;void 0!==this.video&&this.context&&this.context.clearRect(0,0,null==(e=this.video)?void 0:e.videoWidth,null==(t=this.video)?void 0:t.videoHeight)}},{key:"render",value:function(){var e,t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.canvas;var n=v(this.getScale(),8),r=n[0],o=n[1],a=n[2],s=n[3],c=n[4],u=n[5],h=n[6],d=n[7];(null==(t=null==(e=this.videoEntity)?void 0:e.config)?void 0:t.descript)?this.renderMix(i):this.renderLR(i),this.context.clearRect(c,u,h,d),this.context.drawImage(this.ofs,r,o,a,s,c,u,h,d)}},{key:"drawWithCache",value:function(e){if(this.op.useFrameCache){var t=v(this.getScale(),8),i=t[0],n=t[1],r=t[2],o=t[3],a=t[4],s=t[5],c=t[6],u=t[7],h=this.renderCache.getCache(e);if(console.log("[canvas2d frameItem]",e,h),h&&"skip"!==h)return this.context.clearRect(a,s,c,u),this.context.drawImage(h,i,n,r,o,a,s,c,u),!0}}},{key:"saveFrameCache",value:function(e){this.op.useFrameCache&&this.renderCache.setCache(e)}},{key:"renderKey",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=this.videoEntity.getFrame(t),n=i?i[this.videoEntity.data]:void 0;n&&n.forEach(function(t){var i=v(t[e.videoEntity.renderFrame],4),n=i[0],r=i[1],o=i[2],a=i[3],s=v(t[e.videoEntity.outputFrame],4),c=s[0],u=s[1],h=s[2],d=s[3],l=t[e.videoEntity.effectId],f=e.drawEffect[l]||{};if(f.img&&o>0&&a>0&&d>0&&h>0){e.ctxKey.clearRect(0,0,o,a),e.ctxKey.drawImage(f.img,0,0,o,a);var p=e.ctx.getImageData(c,u,h,d),m=e.ctxKey.getImageData(0,0,o,a);m=e.mixImageData(m,p,o/h),e.ctxKey.clearRect(0,0,o,a),e.ctxKey.putImageData(m,0,0),e.ctx.drawImage(e.canvasKey,0,0,o,a,n,r,o,a)}})}},{key:"renderMix",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=null==(e=this.videoEntity.config)?void 0:e.descript;if(this.ctx&&this.isPlay&&void 0!==this.video&&i){var n=v(i.rgbFrame,4),r=n[0],o=n[1],a=n[2],s=n[3],c=v(i.alphaFrame,4),u=c[0],h=c[1],d=c[2],l=c[3];this.ctx.clearRect(u,h,a,s);var f=this.video.videoWidth,p=this.video.videoHeight;this.ctx.drawImage(this.video,0,0,f,p,0,0,f,p);var m=this.ctx.getImageData(r,o,a,s),y=this.ctx.getImageData(u,h,d,l);m=this.mixImageData(m,y,a/d),this.ctx.clearRect(0,0,a,s),this.ctx.putImageData(m,0,0,0,0,a,s),this.renderKey(t)}}},{key:"mixImageData",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;1!==i&&(t=this.scaleImageData(t,i));for(var n=Math.min(null==e?void 0:e.data.length,null==t?void 0:t.data.length),r=3;r<n;r+=4){var o=t.data[r-1];e.data[r]=o,o>0&&(e.data[r-1]=Math.min(255,Math.ceil(255*e.data[r-1]/o)),e.data[r-2]=Math.min(255,Math.ceil(255*e.data[r-2]/o)),e.data[r-3]=Math.min(255,Math.ceil(255*e.data[r-3]/o)))}return e}},{key:"scaleImageData",value:function(e,t){if(1==t)return e;for(var i=this.alphaCtx,n=Math.floor(e.width*t),r=Math.floor(e.height*t),o=i.createImageData(n,r),a=e.width,s=e.height,c=0;c<s;c++)for(var u=0;u<a;u++){for(var h=[e.data[4*(c*e.width+u)+0],e.data[4*(c*e.width+u)+1],e.data[4*(c*e.width+u)+2],e.data[4*(c*e.width+u)+3]],d=0;d<t;d++){for(var l=Math.floor(c*t)+d,f=0;f<t;f++){for(var v=Math.floor(u*t)+f,p=0;p<4;p++)o.data[4*(l*n+v)+p]=h[p]}}}return o}},{key:"renderLR",value:function(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0],this.ctx&&this.isPlay&&void 0!==this.video){var e=this.video.videoWidth,t=this.video.videoHeight,i=e/2;if(this.ctx.drawImage(this.video,0,0,e,t,0,0,e,t),"left"===this.op.alphaDirection){var n=this.ctx.getImageData(i,0,i,t),r=this.ctx.getImageData(0,0,i,t);this.mixImageData(n,r),this.ctx.putImageData(n,0,0,0,0,i,t)}else{var o=this.ctx.getImageData(i,0,i,t),a=this.ctx.getImageData(0,0,i,t);this.mixImageData(a,o),this.ctx.putImageData(a,0,0,0,0,i,t)}}}}]),o}(function(){function e(){s(this,e)}return u(e,[{key:"createCanvas",value:function(){return H()&&self.createImageBitmap?new OffscreenCanvas(300,300):document.createElement("canvas")}},{key:"removeCanvas",value:function(e){d(e,HTMLCanvasElement)?e.remove():e=void 0}},{key:"get2dContext",value:function(e){return e.getContext("2d",{willReadFrequently:!0})}}]),e}()),J=["playing","pause","ended","progress","loadstart","stop","loadeddata","loadedmetadata","ratechange","abort","emptied","error","mozaudioavailable","stalled","suspend","play","waiting","canplay","canplaythrough","seeked","seeking"],$=function(){function e(t,i){var n=this;s(this,e),E(this,"animateId"),E(this,"animationType"),E(this,"video"),E(this,"fps",20),E(this,"videoFps",0),E(this,"frameDelay",0),E(this,"frameStartTime",0),E(this,"op"),E(this,"isPlay"),E(this,"requestAnim"),E(this,"cancelAnim"),E(this,"onUpdate"),E(this,"currentTimeMillsecond",function(){return("undefined"==typeof performance?"undefined":m(performance))>"u"?new Date().getTime():performance.now()}),E(this,"drawFrame",function(){arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.currentTimeMillsecond();var e=arguments.length>1?arguments[1]:void 0;if(n.isPlay){n.cancelAnim(),n.animateId=n.requestAnim(n.drawFrame);var t=(null==e?void 0:e.mediaTime)||n.video.currentTime,i=n.getCurrentFrame(t);n.onUpdate&&n.onUpdate(i)}}),this.video=t,this.op=i,this.isPlay=!1,"requestVideoFrameCallback"in HTMLVideoElement.prototype&&this.op.useAccurate?this.animationType="requestVideoFrameCallback":("undefined"==typeof requestAnimationFrame?"undefined":m(requestAnimationFrame))<"u"?this.animationType="requestAnimationFrame":this.animationType="setTimeout",this.requestAnim=this.returnRequestAnim(),this.cancelAnim=this.returnCancelAnim()}return u(e,[{key:"setVideoFps",value:function(e){var t=e.videoFps,i=e.fps;this.fps=i,this.videoFps=t,"requestVideoFrameCallback"!==this.animationType&&this.fps>20&&(this.fps=20)}},{key:"setup",value:function(){var e=this;return a(function(){return g(this,function(t){return e.frameDelay=1e3/e.fps,[2]})})()}},{key:"start",value:function(){0===this.frameDelay&&this.fps>0&&(this.frameDelay=1e3/this.fps),T.debug("animator start",this.animateId,this.frameDelay,this.fps),this.frameStartTime=this.currentTimeMillsecond(),this.cancelAnim(),this.animateId=this.requestAnim(this.drawFrame)}},{key:"stop",value:function(){T.debug("animator stop",this.animateId),this.cancelAnim()}},{key:"destroy",value:function(){T.debug("[animator destroy]",this.animateId),this.cancelAnim(),this.op=void 0,this.video=void 0,this.cancelAnim=void 0,this.requestAnim=void 0,this.onUpdate=void 0,this.drawFrame=void 0}},{key:"getCurrentFrame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return Math.round(e*this.videoFps)+(this.op.offset||0)}},{key:"returnRequestAnim",value:function(){var e=this;switch(this.animationType){case"requestVideoFrameCallback":return function(t){return e.animateId=e.video.requestVideoFrameCallback(t)};case"requestAnimationFrame":return function(t){return requestAnimationFrame(function(){var i=e.currentTimeMillsecond(),n=i-e.frameStartTime;if(n>e.frameDelay)return e.frameStartTime=i-n%e.frameDelay,t();e.requestAnim&&(e.animateId&&e.cancelAnim(),e.animateId=e.requestAnim(t))})};default:return function(t){return e.animateId=window.setTimeout(t,1e3/e.fps)}}}},{key:"returnCancelAnim",value:function(){var e=this;switch(this.animationType){case"requestVideoFrameCallback":return function(){return e.animateId&&e.video.cancelVideoFrameCallback(e.animateId)};case"requestAnimationFrame":return function(){return e.animateId&&cancelAnimationFrame(e.animateId)};default:return function(){return e.animateId&&clearTimeout(e.animateId)}}}}]),e}(),Q=Object.freeze({UNCOMPRESSED:0,FIXED:1,DYNAMIC:2}),ee=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],et=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],ei=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],en=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],er=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function eo(e){var t=Object.keys(e),i=0,n=0,r=Number.MAX_SAFE_INTEGER;t.forEach(function(e){i=Number(e),n<i&&(n=i),r>i&&(r=i)});for(var o,a=0,s={},c=r;c<=n;c++)!function(t){void 0===(o=e[t])&&(o=[]),o.sort(function(e,t){return e<t?-1:e>t?1:0});var i={};o.forEach(function(e){i[a]=e,a++}),s[t]=i,a<<=1}(c);return s}var ea=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;s(this,e),this.nowBitsLength=0,this.isEnd=!1,this.buffer=t,this.bufferIndex=i,this.nowBits=t[i],this.nowBitsLength=8}return u(e,[{key:"read",value:function(){if(this.isEnd)throw Error("Lack of data length");var e=1&this.nowBits;return this.nowBitsLength>1?(this.nowBitsLength--,this.nowBits>>=1):(this.bufferIndex++,this.bufferIndex<this.buffer.length?(this.nowBits=this.buffer[this.bufferIndex],this.nowBitsLength=8):(this.nowBitsLength=0,this.isEnd=!0)),e}},{key:"readRange",value:function(e){for(;this.nowBitsLength<=e;)this.nowBits|=this.buffer[++this.bufferIndex]<<this.nowBitsLength,this.nowBitsLength+=8;var t=this.nowBits&(1<<e)-1;return this.nowBits>>>=e,this.nowBitsLength-=e,t}},{key:"readRangeCoded",value:function(e){for(var t=0,i=0;i<e;i++)t<<=1,t|=this.read();return t}}]),e}(),es=function(){function e(t){s(this,e),this.index=0,this.buffer=new Uint8Array(t),this.length=t,this._extendedSize=t}return u(e,[{key:"write",value:function(e){if(this.length<=this.index){this.length+=this._extendedSize;for(var t=new Uint8Array(this.length),i=this.buffer.length,n=0;n<i;n++)t[n]=this.buffer[n];this.buffer=t}this.buffer[this.index]=e,this.index++}}]),e}(),ec=eo(function(){for(var e={7:[],8:[],9:[]},t=0;t<=287;t++)t<=143?e[8].push(t):t<=255?e[9].push(t):t<=279?e[7].push(t):e[8].push(t);return e}()),eu=RegExp("yyeffectmp4json\\[\\[(.*?)\\]\\]yyeffectmp4json"),eh=new(function(){function e(){s(this,e),E(this,"exp"),this.exp=/eJzt3U1v20gMgOH/g}return u(e,[{key:"getdata",value:function(e){try{var t=e.match(eu);if(!t)return;var i=t[1],n=this.inflate(i),r=this.unit8Tostring(n);return r=JSON.parse(r),T.debug("[ParserGetData]",r),r}catch(e){return void T.warn(e)}}},{key:"base64ToArrayBuffer",value:function(e){for(var t=window.atob(e),i=t.length,n=new Uint8Array(i),r=0;r<i;r++)n[r]=t.charCodeAt(r);return n.buffer}},{key:"unit8Tostring",value:function(e){return new TextDecoder().decode(e)}},{key:"inflate",value:function(e){return function(e){var t=new ea(e);if(8!==t.readRange(4))throw Error("Not compressed by deflate");return t.readRange(4),t.readRange(5),t.readRange(1),t.readRange(2),function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=new es(10*e.length),n=new ea(e,t),r=0,o=0;1!==r;){if(r=n.readRange(1),(o=n.readRange(2))===Q.UNCOMPRESSED)(function(e,t){e.nowBitsLength<8&&e.readRange(e.nowBitsLength);var i=e.readRange(8)|e.readRange(8)<<8;if(i+(e.readRange(8)|e.readRange(8)<<8)!==65535)throw Error("Data is corrupted");for(var n=0;n<i;n++)t.write(e.readRange(8))})(n,i);else if(o===Q.FIXED)(function(e,t){var i=Object.keys(ec),n=0,r=0,o=Number.MAX_SAFE_INTEGER;i.forEach(function(e){n=Number(e),r<n&&(r=n),o>n&&(o=n)});for(var a,s,c,u,h,d,l,f,v=0;!e.isEnd;){for(a=void 0,n=o,v=e.readRangeCoded(o);void 0===(a=ec[n][v]);){if(r<=n)throw Error("Data is corrupted");n++,v<<=1,v|=e.read()}if(a<256)t.write(a);else{if(256===a)break;c=et[s=a-257],0<(u=ee[s])&&(c+=e.readRange(u)),d=ei[h=e.readRangeCoded(5)],0<(l=en[h])&&(d+=e.readRange(l)),f=t.index-d;for(var p=0;p<c;p++)t.write(t.buffer[f+p])}}})(n,i);else{if(o!==Q.DYNAMIC)throw Error("Not supported BTYPE : "+o);(function(e,t){for(var i=e.readRange(5)+257,n=e.readRange(5)+1,r=e.readRange(4)+4,o=0,a={},s=0;s<r;s++)0!==(o=e.readRange(3))&&(a[o]||(a[o]=[]),a[o].push(er[s]));var c=eo(a),u=Object.keys(c),h=0,d=Number.MAX_SAFE_INTEGER;u.forEach(function(e){o=Number(e),h<o&&(h=o),d>o&&(d=o)});for(var l={},f={},v,p=0,m=0,y=0,g=i+n,b=0;b<g;){for(v=void 0,o=d,p=e.readRangeCoded(d);void 0===(v=c[o][p]);){if(h<=o)throw Error("Data is corrupted");o++,p<<=1,p|=e.read()}if(16===v?m=3+e.readRange(2):17===v?(m=3+e.readRange(3),y=0):18===v?(m=11+e.readRange(7),y=0):(m=1,y=v),y<=0)b+=m;else for(;m;)b<i?(l[y]||(l[y]=[]),l[y].push(b++)):(f[y]||(f[y]=[]),f[y].push(b++-i)),m--}var x=eo(l),w=eo(f),C=Object.keys(x),E=0,k=0,_=Number.MAX_SAFE_INTEGER;C.forEach(function(e){E=Number(e),k<E&&(k=E),_>E&&(_=E)});var T=Object.keys(w),F=0,I=0,S=Number.MAX_SAFE_INTEGER;T.forEach(function(e){F=Number(e),I<F&&(I=F),S>F&&(S=F)});for(var R,A,P,D,L,B,U,O,M,N,V=0;!e.isEnd;){for(R=void 0,E=_,V=e.readRangeCoded(_);void 0===(R=x[E][V]);){if(k<=E)throw Error("Data is corrupted");E++,V<<=1,V|=e.read()}if(R<256)t.write(R);else{if(256===R)break;for(P=et[A=R-257],0<(D=ee[A])&&(P+=e.readRange(D)),L=void 0,O=S,M=e.readRangeCoded(S);void 0===(L=w[O][M]);){if(I<=O)throw Error("Data is corrupted");O++,M<<=1,M|=e.read()}B=ei[L],0<(U=en[L])&&(B+=e.readRange(U)),N=t.index-B;for(var H=0;H<P;H++)t.write(t.buffer[N+H])}}})(n,i)}if(0===r&&n.isEnd)throw Error("Data length is insufficient")}return i.buffer.subarray(0,i.index)}(e,2)}(new Uint8Array(this.base64ToArrayBuffer(e)))}}]),e}()),ed=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{name:"e-video",version:1,storeName:"video"},i=t.name,n=t.version,r=t.storeName;s(this,e),E(this,"storeName"),E(this,"dbPromise"),T.debug("[DBCache] DB",i,n,r),this.storeName=r,this.dbPromise=new Promise(function(e,t){if(void 0!==self.indexedDB){var o=self.indexedDB.open(i,n);o.onerror=function(t){return T.warn("IndexedDB open fail, ".concat(t.type)),e(void 0)},o.onsuccess=function(){return e(o.result)},o.onupgradeneeded=function(e){var t=o.result;e.oldVersion&&e.oldVersion<e.newVersion&&(T.debug("[DB] deleteObjectStore"),t.deleteObjectStore(r)),t.createObjectStore(r)}}else t("IndexedDB not supported")})}return u(e,[{key:"find",value:function(e){var t=this;return a(function(){return g(this,function(i){switch(i.label){case 0:var n;return[4,t.dbPromise.then((n=a(function(i){return g(this,function(n){switch(n.label){case 0:return[4,new Promise(function(n,r){var o=i.transaction([t.storeName],"readonly").objectStore(t.storeName).get(e);o.onsuccess=function(){n(o.result)},o.onerror=function(){return r(Error("Find Error"))}})];case 1:return[2,n.sent()]}})}),function(e){return n.apply(this,arguments)}))];case 1:return[2,i.sent()]}})})()}},{key:"insert",value:function(e,t){var i=this;return a(function(){return g(this,function(n){switch(n.label){case 0:var r;return[4,i.dbPromise.then((r=a(function(n){return g(this,function(r){switch(r.label){case 0:return[4,new Promise(function(r,o){var a=n.transaction([i.storeName],"readwrite"),s=a.objectStore(i.storeName).put(t,e);a.oncomplete=function(){return r()},s.onerror=function(){return o(Error("Insert Error"))}})];case 1:return[2,r.sent()]}})}),function(e){return r.apply(this,arguments)}))];case 1:return[2,n.sent()]}})})()}},{key:"delete",value:function(e){var t=this;return a(function(){return g(this,function(i){switch(i.label){case 0:var n;return[4,t.dbPromise.then((n=a(function(i){return g(this,function(n){switch(n.label){case 0:return[4,new Promise(function(n,r){var o=i.transaction([t.storeName],"readwrite").objectStore(t.storeName).delete(e);o.onsuccess=function(){return n()},o.onerror=function(){return r(Error("Delete Error"))}})];case 1:return[2,n.sent()]}})}),function(e){return n.apply(this,arguments)}))];case 1:return[2,i.sent()]}})})()}}]),e}(),el=new(function(){function e(){s(this,e),E(this,"useIndexDB",!0),E(this,"db")}return u(e,[{key:"IndexDB",set:function(e){this.useIndexDB=e,T.debug("[DBCache] IndexDB",this.useIndexDB)}},{key:"model",value:function(){return("undefined"==typeof window?"undefined":m(window))<"u"&&this.useIndexDB?(this.db||(T.debug("[DBCache] new DB"),this.db=new ed),this.db):this}},{key:"find",value:function(e){return a(function(){return g(this,function(e){return[2]})})()}},{key:"insert",value:function(e,t){return a(function(){return g(this,function(e){return[2]})})()}},{key:"delete",value:function(e){return a(function(){return g(this,function(e){return[2]})})()}}]),e}()),ef=function(){function e(t,i){s(this,e),E(this,"loopCount",1/0),E(this,"_endFrame",-1),E(this,"playedLoopCount",0),E(this,"lastFrameIndex",0),E(this,"onEnd"),E(this,"onLoopCount");var n=void 0===t?"undefined":m(t);"boolean"===n?this.loopCount=t?1/0:1:"number"===n&&(this.loopCount=Number(t)),void 0!==i&&(this._endFrame=i)}return u(e,[{key:"reset",value:function(){this.playedLoopCount=0,this.lastFrameIndex=0}},{key:"setEndFrame",value:function(e){T.info("[LoopChecker]setEndFrame value=",e),void 0!==e&&(this._endFrame=e)}},{key:"checkFrame",value:function(e){return this._endFrame>10?this.lastFrameIndex<this._endFrame&&this.lastFrameIndex>this._endFrame/2&&(e>=this._endFrame||e<=this._endFrame/2):(this.lastFrameIndex<this._endFrame||this.lastFrameIndex>10)&&e>=this._endFrame&&e<10}},{key:"updateFrame",value:function(e){return this.checkFrame(e)&&(T.info("[LoopChecker] this.playedLoopCount=",this.playedLoopCount,", this.lastFrameIndex=",this.lastFrameIndex,", frame",e,", endFrame=",this._endFrame,", this.loopCount=",this.loopCount),this.playedLoopCount=this.playedLoopCount+1,this.onLoopCount&&this.onLoopCount({count:this.playedLoopCount}),this.playedLoopCount===this.loopCount)?(this.onEnd&&this.onEnd(),!1):(this.lastFrameIndex=e,!0)}}]),e}(),ev=function(){function e(t){var i=this;if(s(this,e),E(this,"video"),E(this,"eventsFn",{}),E(this,"animator"),E(this,"blobUrl"),E(this,"polyfillCreateObjectURL"),E(this,"timeoutId",null),E(this,"loopChecker"),E(this,"videoFile"),E(this,"isSupportHevc",!1),E(this,"startFlag",!1),E(this,"pollyfillTipsElement"),E(this,"onStart"),E(this,"onResume"),E(this,"onPause"),E(this,"onStop"),E(this,"onProcess"),E(this,"onEnd"),E(this,"onError"),E(this,"onLoadedmetadata"),E(this,"isPlay",!1),E(this,"renderer"),E(this,"renderType"),E(this,"animationType"),E(this,"op"),E(this,"fps",0),E(this,"version"),E(this,"webglVersion"),E(this,"setPlay",function(e){i.renderer&&(i.renderer.isPlay=e,i.animator.isPlay=e,i.isPlay=e)}),E(this,"videoEvent",function(e){T.debug("[".concat(e.type,"]:")),i.eventsFn[e.type]&&i.eventsFn[e.type]()}),E(this,"videoVisbility",function(){T.debug("[visibilitychange]",document.hidden,"this.isPlay=",i.isPlay),document.hidden?(T.debug("[visibilitychange] pause"),i.video.pause()):(T.debug("[visibilitychange] play"),i.isPlay&&i._playVideo())}),!t.container)throw Error("container is need!");if(!t.videoUrl)throw Error("videoUrl is need!");this.op=t,this.loopChecker=new ef(this.op.loop,this.op.endFrame),this.loopChecker.onLoopCount=this.op.onLoopCount,this.video=this.videoCreate(),this.animator=new $(this.video,this.op),this.polyfillCreateObjectURL=(O.baidu||O.quark||O.uc)&&!1===this.op.forceBlob,"canvas2d"===this.op.renderType?(this.renderer=new Z(this.op),this.renderType="canvas2d"):(this.renderer=new Y(this.op),this.renderType="webgl"),this.webglVersion=this.renderer.webgl.version,"canvas2d"===this.webglVersion&&"webgl"==this.renderType&&(this.op.renderType="canvas2d",T.debug("[player] webgl to canvas2d"),this.renderer.destroy(),this.renderer=new Z(this.op),this.renderType="canvas2d"),el.IndexDB=this.op.useVideoDBCache,this.loopChecker.onEnd=function(){T.debug("[player] onEnd...url:",i.op.videoUrl),i._onEnd()}}return u(e,[{key:"_onEnd",value:function(){this.stop();var e=this.onEnd;this.op.endPause||this.destroy(),e&&e()}},{key:"_error",value:function(e){T.error("[EVdeo] error err:",e);var t=this.onEnd,i=this.onError;this.stop(),this.destroy(),t&&(null==t||t(e)),i&&(null==i||i(e))}},{key:"setup",value:function(){var e=this;return a(function(){var t,i,n,r,o,a;return g(this,function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),T.debug("[=== e-video setup ===]"),[4,e.videoLoad()];case 1:return s.sent(),[4,e.renderer.setup(e.video)];case 2:return s.sent(),e.renderer.videoEntity.hasAudio?e.video.muted=void 0!==e.op.mute&&e.op.mute:e.video.muted=!0,e.fps=e.renderer.videoEntity.fps,T.debug("[EVdeo] this.renderer.videoEntity.fps",e.renderer.videoEntity.fps),e.animator.setVideoFps({fps:e.renderer.videoEntity.fps,videoFps:e.renderer.videoEntity.videoFps}),e._updateEndFrame(),[4,e.animator.setup()];case 3:return s.sent(),e.animator.onUpdate=function(t){if(e.loopChecker.updateFrame(t))try{e.renderer.render(t)}catch(t){T.error("[EVdeo] render frame error"),e._error(t)}},e.animationType=e.animator.animationType,e.renderer.renderCache.mCache.setOptions({fps:e.fps,animationType:e.animationType,videoDurationTime:e.video.duration}),T.debug("[setup]",e.animationType,e.webglVersion),"canvas2d"!==e.webglVersion&&"canvas2d"!==e.op.renderType&&(n=e.renderer,r=!!e.op.useFrameCache&&n.renderCache.isCache(),"requestVideoFrameCallback"!==e.animationType&&!e.op.showVideo&&!r&&((o=e.video).style.position="fixed",o.style.opacity="0.1",o.style.left="0",o.style.top="0",o.style.visibility="visible",o.style.width="2px",o.style.height="2px",o.style.pointerEvents="none",o.style.userSelect="none")),[3,5];case 4:return a=s.sent(),null==(t=e.onEnd)||t.call(e,a),null==(i=e.onError)||i.call(e,a),e.destroy(),T.error(a),[3,5];case 5:return[2]}})})()}},{key:"_updateEndFrame",value:function(){var e=this.op.endFrame,t=this.video.duration,i=Math.max(0,Math.floor(this.fps*t)-5);this.op.endPause&&(void 0===e||e<0)&&(e=i),e=Math.min(i,e||0),T.debug("[player]_updateEndFrame, endFrame=",e,", op.endFrame=",this.op.endFrame),this.loopChecker.setEndFrame(e)}},{key:"isDestroyed",value:function(){T.debug("player is destroyed!")}},{key:"start",value:function(){if(T.debug("player start!, url=",this.op.videoUrl),!this.renderer)return this.isDestroyed();this.startFlag=!0,this.startEvent()}},{key:"cleanTimer",value:function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}},{key:"beginTimer",value:function(){var e=this;T.debug("[player]beginTimer..., duration=",this.video.duration,"loop=",this.loop(),"checkTimeout=",this.op.checkTimeout),1===this.loopChecker.loopCount&&this.op.checkTimeout&&this.video.duration>0&&(this.cleanTimer(),this.timeoutId=setTimeout(function(){T.debug("[player] timeout...url:",e.op.videoUrl),e._onEnd()},1e3*this.video.duration+100))}},{key:"clickToPlay",value:function(){var e,t,i;this.op.onRequestClickPlay?this.pollyfillTipsElement=this.op.onRequestClickPlay(this.op.container,this.video):this.pollyfillTipsElement=(e=this.op.container,t=this.video,(i=document.createElement("div")).innerText="Click To Play",i.style.textAlign="center",i.style.background="rgba(255,255,255,0.7)",i.style.position="absolute",i.style.zIndex="99999",i.style.top="50%",i.style.left="50%",i.style.padding="10px",i.style.transform="translate(-50%,-50%)",i.style.cursor="pointer",i.style["border-radius"]="5px",e.appendChild(i),i.onclick=function(){t.play(),i.style.display="none"},i)}},{key:"hidePollyfileTips",value:function(){this.pollyfillTipsElement&&this.pollyfillTipsElement&&(this.pollyfillTipsElement.style.display="none")}},{key:"startEvent",value:function(){var e,t,i=this;if(!this.startFlag&&!this.op.autoplay)return void T.info("startEvent() this.startFlag is false");if(this.renderer&&!0!==this.renderer.isPlay){if(this.setPlay(!0),this.animator.start(),this.beginTimer(),this.loopChecker.reset(),this.video.currentTime=0,document.hidden)return void T.info("startEvent() document.hidden..");var n=this.video.play();n?n.then(function(){T.debug(!1===i.op.mute?"声音播放":"静音播放")}).catch(function(e){var t,n;if(O.safari&&O.mac)return T.debug("切换到静音播放",i.op.videoSource),i.video.muted=!0,void i.video.play().catch(function(e){var t,n;T.debug(e),null==(n=null==(t=i.op)?void 0:t.onError)||n.call(t,e)});T.error("play error: ",i.op.videoSource,e,"e?.code=",null==e?void 0:e.code,", e?.name=",null==e?void 0:e.name,", url=",i.op.videoUrl),(null==e?void 0:e.code)!==20&&(i.clickToPlay(),(null==e?void 0:e.code)===0&&(null==e?void 0:e.name)===j.NotAllowedError&&(null==(n=null==(t=i.op)?void 0:t.onError)||n.call(t,{playError:j.NotAllowedError,video:i.video,playStep:W.muted})))}):null==(t=null==(e=this.op)?void 0:e.onEnd)||t.call(e)}}},{key:"stop",value:function(){if(T.debug("[player]stop."),!this.renderer)return this.isDestroyed();!1!==this.renderer.isPlay&&(this.setPlay(!1),this.animator.stop(),this.video.pause(),this.cleanTimer())}},{key:"loop",value:function(){return!!this.op.endPause||this.loopChecker.loopCount>1}},{key:"_playVideo",value:function(){var e=this;if(!this.startFlag&&!this.op.autoplay)return this.video.pause(),void T.info("_playVideo() this.startFlag is false");var t=this.video.play();t&&t.catch(function(t){var i,n;T.warn("_playVideo() error canplaythrough to play",t.code,t.message,t.name),(null==t?void 0:t.code)===0&&(null==t?void 0:t.name)===j.NotAllowedError&&(null==(n=null==(i=e.op)?void 0:i.onError)||n.call(i,{playError:j.NotAllowedError,video:e.video,playStep:W.canplaythrough}))})}},{key:"_updateVideoSource",value:function(e){var t=this.op;d(e,File)?(t.useVideoDBCache=!1,this.videoFile=e,this.op.videoSource=e.name):this.op.videoSource=e}},{key:"videoCreate",value:function(){var e,t,i=this.op;if(this._updateVideoSource(i.videoUrl),O.quark&&O.android){var n=this.op.videoSource.indexOf("?")>-1?"&":"?";this.op.videoSource="".concat(this.op.videoSource).concat(n,"_quark_").concat(Math.round(1e5*Math.random())),this.op.useFrameCache=!1,this.op.useVideoDBCache=!1}var r=this.op.videoID||this.op.videoSource;T.debug("[videoID]",r);var o=r?document.getElementById(r):void 0;return d(o,HTMLVideoElement)?t=o:((t=document.createElement("video")).setAttribute("id",r),document.body.appendChild(t)),this.isSupportHevc=!(!(e=t).canPlayType('video/mp4; codecs="hev1.1.6.L93.B0"')&&!e.canPlayType('video/mp4; codecs="hev1.2.4.L120.B0"')),this.isSupportHevc&&i.hevcUrl&&(this._updateVideoSource(i.hevcUrl),i.videoUrl=i.hevcUrl,this.op.isHevc=!0),this.op.showVideo||(t.style.position="fixed",t.style.opacity="0",t.style.left="-9999px",t.style.top="9999px",t.style.visibility="hidden"),t.loop=this.loop(),t.crossOrigin="anonymous",t.autoplay=this.op.autoplay,t.preload="auto",t.setAttribute("preload","auto"),t.setAttribute("x5-playsinline","true"),t.setAttribute("playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("x-webkit-airplay","allow"),t.setAttribute("t7-video-player-type","h5"),t.setAttribute("x5-video-player-type","h5"),(O.quark||O.uc)&&t.setAttribute("renderer","standard"),t}},{key:"videoAddEvents",value:function(){var e=this;return a(function(){var t;return g(this,function(i){return t=e.video,[2,(e.eventsFn.canplaythrough=function(){T.log("[canplaythrough paused] ",t.paused),t.paused&&(T.log("[canplaythrough] isPlay=",e.isPlay),e.isPlay?e._playVideo():T.log("[canplaythrough] isPlay is false!"))},e.eventsFn.stalled=function(){e.video.load()},e.eventsFn.playing=function(){T.log("[player]on playing."),e.startEvent(),e.onStart&&e.onStart(),e.hidePollyfileTips()},e.eventsFn.pause=function(){T.log("[player]on pause."),e.onPause&&e.onPause()},e.eventsFn.resume=function(){e.startEvent(),e.onResume&&e.onResume()},e.eventsFn.ended=function(){var t=e.onEnd;e.op.onLoopCount&&e.op.onLoopCount({count:1}),e.destroy(),t&&t()},e.eventsFn.progress=function(){e.onProcess&&e.onProcess()},e.eventsFn.stop=function(){e.onStop&&e.onStop()},e.eventsFn.seeked=function(){e.renderer.videoSeekedEvent()},e.eventsFn.error=function(t){e.onError&&e.onError(t)},J.map(function(i){t.addEventListener(i,e.videoEvent,!1)}),document.addEventListener("visibilitychange",e.videoVisbility,!1),new Promise(function(i){e.onLoadedmetadata&&t.removeEventListener("loadedmetadata",e.onLoadedmetadata),e.onLoadedmetadata=function(n){e.videoEvent(n),i(n),T.debug("[video loadedmetadata]",t.videoWidth,t.videoHeight,t.src.length)},t.addEventListener("loadedmetadata",e.onLoadedmetadata)}))]})})()}},{key:"videoLoad",value:function(){var e=this;return a(function(){var t,i,n;return g(this,function(r){switch(r.label){case 0:if(t=e.video,!e.op.usePrefetch)return[3,2];return[4,e.prefetch()];case 1:return i=r.sent(),t.src=i,T.debug("[prefetch url]",i),[3,6];case 2:if(t.src=e.op.videoSource,!e.op.useMetaData)return[3,5];return[4,e.getVideoFile()];case 3:return n=r.sent(),[4,e.readFileToBlobUrl(n)];case 4:r.sent(),r.label=5;case 5:T.debug("[videoSource url]",e.op.videoSource),r.label=6;case 6:return t.load(),T.debug("[video load]"),[4,e.videoAddEvents()];case 7:return r.sent(),[2]}})})()}},{key:"removeVideoEvent",value:function(){var e=this;J.map(function(t){e.video.removeEventListener(t,e.videoEvent,!1)}),document.removeEventListener("visibilitychange",this.videoVisbility,!1),this.video&&(this.video.removeEventListener("loadedmetadata",this.onLoadedmetadata,!1),this.video.pause(),this.op.videoID||(this.video.removeAttribute("src"),this.video.load(),this.video.remove()))}},{key:"revokeObjectURL",value:function(e){this.blobUrl&&(URL.revokeObjectURL(this.blobUrl),T.debug("[".concat(e," revokeObjectURL]"),this.blobUrl.length),this.blobUrl=void 0)}},{key:"createObjectURL",value:function(e){return T.debug("[createObjectURL]"),URL.createObjectURL(e)}},{key:"destroy",value:function(){if(!this.renderer)return this.isDestroyed();this.revokeObjectURL("destroy"),T.debug("[destroy]"),this.setPlay(!1),this.removeVideoEvent(),this.renderer.destroy(),this.animator.destroy(),this.renderer=void 0,this.animator=void 0,this.version=void 0,this.videoFile=void 0,this.videoVisbility=void 0,this.onLoadedmetadata=void 0,this.onStart=void 0,this.onResume=void 0,this.onPause=void 0,this.onStop=void 0,this.onProcess=void 0,this.onEnd=void 0,this.onError=void 0,this.cleanTimer(),this.videoEvent=void 0,this.eventsFn={}}},{key:"checkVideoCache",value:function(){var e=this;return a(function(){var t,i,n,r;return g(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,el.model().find(e.op.videoSource)];case 1:if(t=o.sent())return i=t.blob,[2,((n=t.data)&&e.renderer.videoEntity.setConfig(n),T.debug("[checkVideoCache]"),e.blobUrl=e.createObjectURL(i),e.blobUrl)];return[3,3];case 2:return r=o.sent(),T.error(r),[3,3];case 3:return[2]}})})()}},{key:"getVideoFile",value:function(){var e=this;return a(function(){var t,i;return g(this,function(n){switch(n.label){case 0:if(!e.videoFile)return[3,1];return i=e.videoFile,[3,3];case 1:return[4,function(e){var t,i=this;return new Promise((t=a(function(t,n){return g(this,function(n){switch(n.label){case 0:return[4,fetch(e).then(function(e){return e.ok?e.blob():void T.error("fetch request failed, url: "+i.op.videoSource)}).catch(function(e){T.error("getVideoByHttp fetch, err=",e)})];case 1:return t.apply(void 0,[n.sent()]),[2]}})}),function(e,i){return t.apply(this,arguments)}))}(e.op.videoSource)];case 2:i=n.sent(),n.label=3;case 3:return[2,t=i]}})})()}},{key:"prefetch",value:function(){var e=this;return a(function(){var t,i,n;return g(this,function(r){switch(r.label){case 0:if(!(e.op.useVideoDBCache&&!e.polyfillCreateObjectURL))return[3,2];return[4,e.checkVideoCache()];case 1:if(t=r.sent())return[2,t];r.label=2;case 2:return[4,e.getVideoFile()];case 3:return i=r.sent(),[4,e.readFileToBlobUrl(i)];case 4:return n=r.sent(),[2,(T.debug("[prefetch result]",n,"this.op.useVideoDBCache",e.op.useVideoDBCache),n)]}})})()}},{key:"readFileToBlobUrl",value:function(e){var t=this;return new Promise(function(i,n){var r=new FileReader;r.readAsDataURL(e),r.onloadend=function(){var e,n=r.result,o=atob(n.slice(n.indexOf(",")+1));if(RegExp("H.265/HEVC").test(o)&&(t.op.isHevc=!0),t.op.useMetaData&&(e=eh.getdata(o))&&t.renderer.videoEntity.setConfig(e),t.polyfillCreateObjectURL)i(t.op.videoSource);else{for(var a=Array(o.length),s=0;s<o.length;s++)a[s]=o.charCodeAt(s);var c=new Blob([new Uint8Array(a)],{type:"video/mp4"});t.op.useVideoDBCache&&el.model().insert(t.op.videoSource,{blob:c,data:e}),t.blobUrl=t.createObjectURL(c),i(t.blobUrl)}n=void 0,o=void 0}})}}]),e}();function ep(e){return em.apply(this,arguments)}function em(){return(em=a(function(e){var t,i,n;return g(this,function(r){switch(r.label){case 0:if((t=l({showVideo:!1,useWorker:!1,loop:!0,autoplay:!0,videoUrl:"",videoID:null,dataUrl:"",offset:0,usePrefetch:!0,useBitmap:!0,useAccurate:!1,useMetaData:!1,alphaDirection:"left",useVideoDBCache:!0,useFrameCache:!1,useOfsRender:!1,resizeCanvas:"percent",showPlayerInfo:!0,forceBlob:!1,checkTimeout:!1,endPause:!1,font:{overflow:"cut"}},e)).useMetaData&&t.usePrefetch&&(t.usePrefetch=!0),t.useFrameCache&&(t.useOfsRender=!0),self.createImageBitmap||(t.useBitmap=!1),H()&&t.useOfsRender||(t.useOfsRender=!1,t.useFrameCache=!1),self.indexedDB||(t.useVideoDBCache=!1),O.android&&O.baidu&&(t.useAccurate=!1),T.setup({level:t.logLevel,showtips:!!t.showPlayerInfo}),!(i=O.weixin&&O.ios))return[3,2];return[4,N.wxReady()];case 1:i=r.sent(),r.label=2;case 2:return n=new ev(t),t.onStart&&(n.onStart=t.onStart),t.onStop&&(n.onStop=t.onStop),t.onEnd&&(n.onEnd=t.onEnd),t.onPause&&(n.onPause=t.onPause),t.onResume&&(n.onResume=t.onResume),t.onProcess&&(n.onProcess=t.onProcess),t.onError&&(n.onError=t.onError),[4,n.setup()];case 3:return[2,(r.sent(),t.showPlayerInfo&&function(e,t){if("table"===e.showPlayerInfo)return console.table({Version:k,RenderType:"canvas2d"===e.renderType?e.renderType:"WebGL.".concat(t.webglVersion),FPS:t.fps,DisplayMode:e.mode,LoadType:e.usePrefetch?" MSE":"src",OffScreenRender:!!e.useOfsRender,UseFrameCache:!!e.useFrameCache,UseVideoDBCache:!!e.useVideoDBCache,AnimationType:t.animationType});console.log("%c ".concat(_," ").concat(k," %c ").concat("canvas2d"===e.renderType?e.renderType:"WebGL.".concat(t.webglVersion)).concat(self.devicePixelRatio?" DPR.".concat(self.devicePixelRatio):""," FPS.").concat(t.fps).concat(e.mode?" ".concat(e.mode):"").concat(e.isHevc?" H265":" H264").concat(e.usePrefetch?" MSE":"").concat(e.useOfsRender?" OfsRender":"").concat(e.useFrameCache?" FrameCache":"").concat(e.useVideoDBCache?" VideoCache":""," ").concat(t.animationType," %c"),"background:#34495e ; padding: 1px; border-radius: 2px 0 0 2px;  color: #fff","background:#16a085 ; padding: 1px; border-radius: 0 2px 2px 0;  color: #fff","background:transparent")}(t,n),n)]}})})).apply(this,arguments)}var ey=k}}]);